# =============================================================================
# Docker Compose Configuration for Production (Docker Hub)
# =============================================================================
# This compose file pulls pre-built images from Docker Hub instead of
# building locally. This is intended for production deployments.
#
# PREREQUISITE: Images must be pushed to Docker Hub first!
#   Run: ./build-and-push.sh (Linux/Mac)
#   Or:  build-and-push.bat (Windows)
#
# Usage:
#   Pull:   docker compose -f docker-compose.production.yml pull
#   Run:    docker compose -f docker-compose.production.yml up -d
#   Stop:   docker compose -f docker-compose.production.yml down
#   Logs:   docker compose -f docker-compose.production.yml logs -f
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Portfolio Application Service (Production - from Docker Hub)
  # ---------------------------------------------------------------------------
  automedon-portfolio:
    # Pull pre-built image from Docker Hub
    image: makros24/automedon:latest

    # Alternative: Use specific version tag for stability
    # image: makros24/automedon:v1.0.0

    # Container name
    container_name: automedon-portfolio-production

    # Port mapping (host:container)
    ports:
      - "3000:3000"

    # Environment variables
    environment:
      # Application environment
      - NODE_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0

      # Portfolio configuration
      - PORTFOLIO_CONFIG_PATH=/app/portfolio-data

      # Application URLs (customize for your deployment)
      - NEXT_PUBLIC_APP_URL=http://localhost:3000

      # Language settings
      - NEXT_PUBLIC_DEFAULT_LANGUAGE=en
      - NEXT_PUBLIC_ENABLE_LANGUAGE_DETECTION=true

      # Feature flags
      - NEXT_PUBLIC_DEBUG_MODE=false
      - NEXT_PUBLIC_SHOW_GRID=false

      # Next.js telemetry
      - NEXT_TELEMETRY_DISABLED=1

    # Volume mounts (OPTIONAL)
    # Uncomment to override portfolio data with local files
    # This allows content updates without rebuilding the image
    # volumes:
    #   - ./portfolio-data:/app/portfolio-data:ro

    # Restart policy
    restart: unless-stopped

    # Health check
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/portfolio?lang=en', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Resource limits (adjust based on your server capacity)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Network configuration
    networks:
      - automedon-network

# -----------------------------------------------------------------------------
# Networks
# -----------------------------------------------------------------------------
networks:
  automedon-network:
    driver: bridge
    name: automedon-network

# -----------------------------------------------------------------------------
# Production Deployment Notes
# -----------------------------------------------------------------------------
# This configuration pulls pre-built images from Docker Hub (makros24/automedon).
# Portfolio data is baked into the Docker image for maximum portability.
#
# Deployment Workflow:
#   1. On development machine:
#      - Run: ./build-and-push.sh (or build-and-push.bat)
#      - This builds and pushes to Docker Hub
#
#   2. On production server:
#      - Run: docker compose -f docker-compose.production.yml pull
#      - Run: docker compose -f docker-compose.production.yml up -d
#      - Access at: http://localhost:3000 (or your domain)
#
# Updating the Application:
#   1. Make code changes on development machine
#   2. Run build-and-push script with new version
#   3. On production:
#      - docker compose -f docker-compose.production.yml pull
#      - docker compose -f docker-compose.production.yml up -d
#
# Rollback to Previous Version:
#   1. Edit this file to use specific version tag:
#      image: makros24/automedon:v1.0.0
#   2. Run: docker compose -f docker-compose.production.yml up -d
#
# Environment Variables:
#   - Override any environment variable by setting it in your shell
#   - Or create a .env file in the same directory
#   - Or modify the environment section above
#
# Volume Mounts:
#   - Portfolio data is included in the image (no volumes needed)
#   - Uncomment volumes section to override with local data
#   - Useful for quick content updates without rebuilding
#
# Monitoring:
#   - Check status: docker compose -f docker-compose.production.yml ps
#   - View logs: docker compose -f docker-compose.production.yml logs -f
#   - Health check: docker inspect automedon-portfolio-production | grep Health
#
# Security Considerations:
#   - Container runs as non-root user (nextjs)
#   - Health checks enabled for monitoring
#   - Resource limits prevent resource exhaustion
#   - Logs rotated to prevent disk fill-up
#
# Performance Tuning:
#   - Adjust resource limits based on your server capacity
#   - Monitor container stats: docker stats automedon-portfolio-production
#   - Scale horizontally by running multiple containers with a load balancer
