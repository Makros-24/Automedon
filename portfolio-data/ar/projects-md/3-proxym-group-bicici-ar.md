## المتطلبات التقنية

منصة الخدمات المصرفية للوكلاء لـ BICICI تمكن الوكلاء المصرفيين من فتح الحسابات وإدارة العملاء. التحديات الأساسية: تنسيق عملية فتح الحساب المكونة من أكثر من 15 خطوة مع التحقق من KYC والتكامل مع النظام المصرفي الأساسي، التكوين الديناميكي للنماذج لمستخدمي الأعمال بدون عمليات نشر، والوصول القائم على الأدوار الهرمية (الوكلاء الرئيسيون، الوكلاء، المشرفون).

<!-- DIAGRAM_PLACEHOLDER: BICICI Agent Platform Architecture - BPMN workflow engine, Formio form builder, agent portal, mobile integration, core banking connectivity -->

## محرك سير العمل BPMN

**Flowable BPM** ينسق عملية فتح الحساب مع منطق التفرع المعقد ومعالجة الأخطاء.

**هيكل سير عمل فتح الحساب**:

1. **إدخال بيانات العميل** (User Task): يقوم الوكيل بإدخال معلومات العميل عبر نموذج Formio ديناميكي
2. **بوابة التحقق** (Service Task): التحقق من العملاء المكررين عبر Elasticsearch
3. **التحقق من KYC** (Parallel Gateway):
   - التحقق من تحميل المستندات (بطاقة الهوية، إثبات العنوان)
   - تكامل API للتعرف على الوجه لتأكيد الهوية
   - تكامل فحص الخلفية
4. **اختيار نوع الحساب** (User Task): يختار الوكيل المنتج بناءً على أهلية العميل
5. **التكامل مع Core Banking** (Service Task): POST لإنشاء الحساب إلى النظام الأساسي لـ BICICI
6. **إصدار البطاقة** (Service Task): طلب بطاقة مادية مع تفاصيل الشحن
7. **الإشعار** (Service Task): تأكيد عبر SMS/email للعميل

**معالجة الأخطاء**: معاملات التعويض لفشل مهام الخدمة. إذا فشل التكامل مع core banking في الخطوة 5، يقوم معالج التعويض بعكس تخزين المستندات وإطلاق قفل العميل. لوحة مراقبة العمليات العالقة تحدد العمليات التي تتجاوز SLA (>30 دقيقة)، مما يتيح التدخل اليدوي.

**العمليات الفرعية القابلة لإعادة الاستخدام**: تم استخراج التحقق من KYC كعملية فرعية مستقلة، يُعاد استخدامها عبر سير عمل فتح الحساب، طلب القرض، واستبدال البطاقة. أحداث حدود الخطأ تلف العمليات الفرعية بمعالجة مركزية للأخطاء.

**المراقبة**: لوحة تحكم Flowable Admin تعرض نسخ العمليات حسب الحالة (نشط، مكتمل، فاشل). مقاييس الأداء المتتبعة: متوسط وقت الإنجاز، معدل الفشل حسب الخطوة، النسخ النشطة لكل وكيل.

<!-- CODE_PLACEHOLDER: BPMN account opening workflow with service tasks, user tasks, gateways, error handling -->

## نظام النماذج الديناميكية

**تكامل Formio** يمكّن مستخدمي الأعمال من تعديل نماذج تأهيل العملاء بدون عمليات نشر.

**Form Builder**: واجهة ويب للمستخدمين غير التقنيين من أجل:
- سحب وإفلات مكونات النموذج (حقول نصية، قوائم منسدلة، تحميل ملفات)
- تعريف قواعد التحقق (أنماط regex، حقول مطلوبة، منطق شرطي)
- تكوين تسميات متعددة اللغات (الفرنسية، العربية مع دعم RTL)
- تعيين رؤية الحقول الشرطية (إظهار إثبات الدخل فقط إذا كان employment_status = "employed")

**عرض النماذج**: الواجهة الأمامية Angular تجلب مخطط JSON للنموذج من الخلفية، عرض ديناميكي. الخلفية تتحقق من صحة الإرسالات مقابل المخطط قبل تقدم سير عمل BPMN.

**التحكم في الإصدار**: مخططات النماذج مخزنة مع سجل الإصدارات. نسخ عمليات BPMN تشير إلى إصدار محدد من النموذج، مما يمنع التغييرات الكاسرة لسير العمل قيد التنفيذ.

## المصادقة والترخيص

**Keycloak OAuth2/OIDC** يدير المصادقة مع الوصول القائم على الأدوار الهرمية:

**التسلسل الهرمي للأدوار**:
- **الوكيل الرئيسي**: جميع العمليات، بما في ذلك إدارة الوكلاء وإعداد التقارير
- **الوكيل**: معاملات العملاء، فتح الحساب (محدود لعملائه الخاصين)
- **المشرف**: وصول للقراءة فقط لجميع أنشطة الوكلاء، سلطة الموافقة على المعاملات عالية القيمة

## البحث والأداء

**Elasticsearch** يفهرس الوكلاء والعملاء للبحث السريع:
- بحث نصي كامل عن اسم العميل، رقم الهوية، الهاتف
- استعلامات جغرافية مكانية لتعيين الوكيل بناءً على الموقع
- التجميعات لإعداد التقارير (العملاء لكل وكيل، توزيع أنواع الحسابات)

**PostgreSQL** للبيانات المعاملاتية مع القفل المتفائل للتحديثات المتزامنة للحسابات.

**Redis** لتخزين الجلسات وذاكرة التخزين المؤقت لبيانات المرجع (كتالوجات المنتجات، جداول الرسوم).

## التحديات التقنية

**تعقيد تنسيق سير العمل**

التحدي: فتح الحساب يتضمن أكثر من 15 خطوة مع منطق التفرع (متطلبات KYC مختلفة للقُصّر مقابل البالغين)، التنفيذ المتوازي (التحقق من المستندات + فحص الخلفية)، وتبعيات الخدمات الخارجية (core banking، بوابة SMS).

الحل: تم تفكيك سير العمل إلى عمليات فرعية قابلة لإعادة الاستخدام (KYC، تكامل core banking، الإشعارات). أحداث حدود الخطأ حول العمليات الفرعية تتعامل مع الفشل بمنطق التعويض. إعادة المحاولة التلقائية مع backoff أسي للفشل المؤقت (انتهاء مهلة الشبكة). قائمة انتظار الرسائل الميتة للفشل الدائم الذي يتطلب تدخل يدوي.

**تطور مخطط النموذج**

التحدي: تغييرات مخطط النموذج تكسر سير العمل قيد التنفيذ التي تشير إلى إصدارات المخطط القديمة.

الحل: مخططات النماذج مُصدّرة في قاعدة البيانات. نسخ عمليات BPMN تخزن مرجعًا لإصدار المخطط المحدد المستخدم عند بدء سير العمل. عارض النموذج يجلب المخطط المُصدّر، مما يضمن الاتساق. الإرسالات الجديدة تستخدم أحدث إصدار من المخطط بينما تكمل سير العمل قيد التنفيذ بالمخطط الأصلي.

<!-- SCREENSHOT_PLACEHOLDER: BICICI Agent Portal - dashboard, customer search, account opening form, transaction history -->